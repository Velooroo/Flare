name: Release

permissions:
  contents: write

on:
  push:
    tags:
      - "v*"

jobs:
  create-release:
    name: üöÄ Create GitHub Release
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ Create Release for tag
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: false
      - name: üìù Summary
        run: |
          echo "# Release triggered" >> "$GITHUB_STEP_SUMMARY"
          echo "- Tag: ${GITHUB_REF#refs/tags/}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Jobs: Linux, macOS, Windows" >> "$GITHUB_STEP_SUMMARY"

  linux:
    name: üêß Linux (ubuntu-latest)
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - name: üîÑ Checkout
        uses: actions/checkout@v3

      - name: üõ†Ô∏è Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: üèó Build workspace (release)
        run: |
          echo "::group::Compile (cargo build --release --all)"
          cargo build --release --all
          echo "::endgroup::"
          echo "::notice title=Linux Build::Binaries in target/release"

      - name: üéõ Prepare names
        id: names
        shell: bash
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"
          echo "FLARE_BARE=os/linux/flare-${VERSION}-linux-amd64" >> "$GITHUB_OUTPUT"
          echo "FLARE_TARGZ=os/linux/flare-${VERSION}-linux-amd64.tar.gz" >> "$GITHUB_OUTPUT"
          echo "FLARED_BARE=os/linux/flared-${VERSION}-linux-amd64" >> "$GITHUB_OUTPUT"
          echo "FLARED_TARGZ=os/linux/flared-${VERSION}-linux-amd64.tar.gz" >> "$GITHUB_OUTPUT"
          echo "BUNDLE=os/linux/linux-amd64-${VERSION}.tar.gz" >> "$GITHUB_OUTPUT"

      - name: üìÅ Arrange assets (bare + bundle)
        shell: bash
        run: |
          set -e
          test -f target/release/flare
          test -f target/release/flared
          mkdir -p os/linux bundle/linux/all bundle/linux/flare bundle/linux/flared

          # Bare copies with folder-like names
          cp "target/release/flare"   "${{ steps.names.outputs.FLARE_BARE }}"
          cp "target/release/flared" "${{ steps.names.outputs.FLARED_BARE }}"

          # Structured bundle
          cp target/release/flare   bundle/linux/all/
          cp target/release/flared  bundle/linux/all/
          cp target/release/flare   bundle/linux/flare/
          cp target/release/flared  bundle/linux/flared/
          tar -czf "${{ steps.names.outputs.BUNDLE }}" -C bundle/linux .

          # Individual tar.gz (optional extras)
          tar -czf "${{ steps.names.outputs.FLARE_TARGZ }}"   -C target/release flare
          tar -czf "${{ steps.names.outputs.FLARED_TARGZ }}" -C target/release flared

      - name: üöÄ Upload Linux assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ steps.names.outputs.FLARE_BARE }}
            ${{ steps.names.outputs.FLARED_BARE }}
            ${{ steps.names.outputs.FLARE_TARGZ }}
            ${{ steps.names.outputs.FLARED_TARGZ }}
            ${{ steps.names.outputs.BUNDLE }}

      - name: üßæ Summary (Linux)
        shell: bash
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          SIZE_FLARE=$(stat -c%s target/release/flare || echo 0)
          SIZE_FLARED=$(stat -c%s target/release/flared || echo 0)
          {
            echo "## Linux ‚úÖ"
            echo ""
            echo "| Artifact | Size (bytes) | Asset name |"
            echo "| --- | ---: | --- |"
            echo "| flare | ${SIZE_FLARE} | ${{ steps.names.outputs.FLARE_BARE }} |"
            echo "| flared | ${SIZE_FLARED} | ${{ steps.names.outputs.FLARED_BARE }} |"
            echo ""
            echo "- üì¶ Extra: ${{ steps.names.outputs.FLARE_TARGZ }}, ${{ steps.names.outputs.FLARED_TARGZ }}"
            echo "- üóÇ Bundle: ${{ steps.names.outputs.BUNDLE }}"
          } >> "$GITHUB_STEP_SUMMARY"

  macos:
    name: üçé macOS (macos-latest)
    runs-on: macos-latest
    needs: create-release
    steps:
      - name: üîÑ Checkout
        uses: actions/checkout@v3

      - name: üõ†Ô∏è Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: üèóÔ∏è Build workspace (release)
        run: |
          echo "::group::Compile (cargo build --release --all)"
          cargo build --release --all
          echo "::endgroup::"
          echo "::notice title=macOS Build::Binaries in target/release"

      - name: üéõ Prepare names
        id: names
        shell: bash
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"
          echo "FLARE_BARE=os/macos/flare-${VERSION}-macos-arm64" >> "$GITHUB_OUTPUT"
          echo "FLARE_TARGZ=os/macos/flare-${VERSION}-macos-arm64.tar.gz" >> "$GITHUB_OUTPUT"
          echo "FLARED_BARE=os/macos/flared-${VERSION}-macos-arm64" >> "$GITHUB_OUTPUT"
          echo "FLARED_TARGZ=os/macos/flared-${VERSION}-macos-arm64.tar.gz" >> "$GITHUB_OUTPUT"
          echo "BUNDLE=os/macos/macos-arm64-${VERSION}.tar.gz" >> "$GITHUB_OUTPUT"

      - name: üìÅ Arrange assets (bare + bundle)
        shell: bash
        run: |
          set -e
          test -f target/release/flare
          test -f target/release/flared
          mkdir -p os/macos bundle/macos/all bundle/macos/flare bundle/macos/flared

          cp "target/release/flare"   "${{ steps.names.outputs.FLARE_BARE }}"
          cp "target/release/flared" "${{ steps.names.outputs.FLARED_BARE }}"

          cp target/release/flare   bundle/macos/all/
          cp target/release/flared bundle/macos/all/
          cp target/release/flare   bundle/macos/flare/
          cp target/release/flared bundle/macos/flared/
          tar -czf "${{ steps.names.outputs.BUNDLE }}" -C bundle/macos .

          tar -czf "${{ steps.names.outputs.FLARE_TARGZ }}"   -C target/release flare
          tar -czf "${{ steps.names.outputs.FLARED_TARGZ }}" -C target/release flared

      - name: üöÄ Upload macOS assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ steps.names.outputs.FLARE_BARE }}
            ${{ steps.names.outputs.FLARED_BARE }}
            ${{ steps.names.outputs.FLARE_TARGZ }}
            ${{ steps.names.outputs.FLARED_TARGZ }}
            ${{ steps.names.outputs.BUNDLE }}

      - name: üßæ Summary (macOS)
        shell: bash
        run: |
          SIZE_FLARE=$(stat -f%z target/release/flare || echo 0)
          SIZE_FLARED=$(stat -f%z target/release/flared || echo 0)
          {
            echo "## macOS ‚úÖ"
            echo ""
            echo "| Artifact | Size (bytes) | Asset name |"
            echo "| --- | ---: | --- |"
            echo "| flare | ${SIZE_FLARE} | ${{ steps.names.outputs.FLARE_BARE }} |"
            echo "| flared | ${SIZE_FLARED} | ${{ steps.names.outputs.FLARED_BARE }} |"
            echo ""
            echo "- üì¶ Extra: ${{ steps.names.outputs.FLARE_TARGZ }}, ${{ steps.names.outputs.FLARED_TARGZ }}"
            echo "- üóÇ Bundle: ${{ steps.names.outputs.BUNDLE }}"
          } >> "$GITHUB_STEP_SUMMARY"

  windows:
    name: ü™ü Windows (windows-latest)
    runs-on: windows-latest
    needs: create-release
    steps:
      - name: üîÑ Checkout
        uses: actions/checkout@v3

      - name: üõ†Ô∏è Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: üèóÔ∏è Build workspace (release)
        run: |
          echo "::group::Compile (cargo build --release --all)"
          cargo build --release --all
          echo "::endgroup::"
          echo "::notice title=Windows Build::Binaries in target/release"

      - name: üéõ Prepare names
        id: names
        shell: pwsh
        run: |
          $v = "${env:GITHUB_REF}".Replace("refs/tags/","")
          echo "VERSION=$v" >> $env:GITHUB_OUTPUT
          echo "FLARE_BARE=os/windows/flare-$v-windows-amd64.exe"     >> $env:GITHUB_OUTPUT
          echo "FLARED_BARE=os/windows/flared-$v-windows-amd64.exe" >> $env:GITHUB_OUTPUT
          echo "FLARE_ZIP=os/windows/flare-$v-windows-amd64.zip"      >> $env:GITHUB_OUTPUT
          echo "FLARED_ZIP=os/windows/flared-$v-windows-amd64.zip"  >> $env:GITHUB_OUTPUT
          echo "BUNDLE=os/windows/windows-amd64-$v.zip"               >> $env:GITHUB_OUTPUT

      - name: üìÅ Arrange assets (bare + bundle + zip)
        shell: pwsh
        run: |
          $releaseDir = "target/release"
          if (!(Test-Path "$releaseDir/flare.exe")) { throw "flare.exe not found in $releaseDir" }
          if (!(Test-Path "$releaseDir/flared.exe")) { throw "flared.exe not found in $releaseDir" }

          New-Item -ItemType Directory -Force os/windows | Out-Null
          New-Item -ItemType Directory -Force bundle/windows/all     | Out-Null
          New-Item -ItemType Directory -Force bundle/windows/flare   | Out-Null
          New-Item -ItemType Directory -Force bundle/windows/flared | Out-Null

          Copy-Item "$releaseDir/flare.exe"   "${{ steps.names.outputs.FLARE_BARE }}"
          Copy-Item "$releaseDir/flared.exe" "${{ steps.names.outputs.FLARED_BARE }}"

          Copy-Item "$releaseDir/flare.exe"   "bundle/windows/all/"
          Copy-Item "$releaseDir/flared.exe" "bundle/windows/all/"
          Copy-Item "$releaseDir/flare.exe"   "bundle/windows/flare/"
          Copy-Item "$releaseDir/flared.exe" "bundle/windows/flared/"

          Compress-Archive -Path "$releaseDir/flare.exe"   -DestinationPath "${{ steps.names.outputs.FLARE_ZIP }}" -Force
          Compress-Archive -Path "$releaseDir/flared.exe" -DestinationPath "${{ steps.names.outputs.FLARED_ZIP }}" -Force
          Compress-Archive -Path "bundle/windows/*"        -DestinationPath "${{ steps.names.outputs.BUNDLE }}"     -Force

      - name: üöÄ Upload Windows assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ steps.names.outputs.FLARE_BARE }}
            ${{ steps.names.outputs.FLARED_BARE }}
            ${{ steps.names.outputs.FLARE_ZIP }}
            ${{ steps.names.outputs.FLARED_ZIP }}
            ${{ steps.names.outputs.BUNDLE }}

      - name: üßæ Summary (Windows)
        shell: pwsh
        run: |
          $sizeSpark   = (Get-Item "target/release/flare.exe").Length
          $sizeSparkle = (Get-Item "target/release/flared.exe").Length
          $summary = @"
